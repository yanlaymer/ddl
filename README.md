### README.md

# Проект "Анализ сделок клиентов"

## Обзор проекта

Этот проект направлен на анализ данных о сделках клиентов на двух разных торговых системах (MT4 и MT5), хранящихся в базе данных PostgreSQL. Основные цели включают:

1. **Рассчет метрик**: Определение количества коротких сделок и пар сделок для каждого пользователя.
2. **Анализ пар пользователей**: Идентификация пар пользователей, которые совершили сделки в определённых условиях.

## Структура проекта

Проект организован следующим образом:

```plaintext
├── data/                     # Директория для хранения выходных CSV файлов
├── src/                      # Исходный код проекта
│   ├── database/             # Логика подключения и запросов к базе данных
│   │   ├── create_engine.py  # Создание движка и сессии базы данных
│   │   ├── queries.py        # SQL запросы для загрузки данных
│   │   ├── config.py         # Конфигурация для подключения к базе данных
│   ├── tasks/                # Логика для обработки задач
│   │   ├── task_1_2.py       # Логика для рассчета метрик (задачи 1 и 2)
│   │   ├── task_3.py         # Логика для анализа пар пользователей (задача 3)
├── Dockerfile                # Docker конфигурация для запуска проекта
├── .env                      # Переменные окружения для подключения к базе данных
├── main.py                   # Основной скрипт для выполнения проекта
├── requirements.txt          # Зависимости Python
└── README.md                 # Документация проекта
```

## Задача

Задача проекта заключалась в следующем:

1. Рассчитать количество коротких сделок (время между открытием и закрытием сделки менее 1 минуты) для каждого пользователя.
2. Найти количество пар сделок для каждого пользователя, которые удовлетворяют следующим условиям:
   - Сделки совершены одним пользователем.
   - Разница между временем открытия сделок не более 30 секунд.
   - Направление сделок противоположное (одна на покупку, другая на продажу).
3. Разделить все время на равные промежутки по 30 секунд и найти пары пользователей, у которых более 10 сделок удовлетворяют условиям:
   - Открытие сделок попало в один промежуток времени.
   - Сделки открыты по одному и тому же инструменту.
   - Сделки принадлежат разным пользователям (одна сделка одного пользователя, другая - другого).
   - Сделки открыты в противоположных направлениях.

## Решение задачи

1. **Загрузка данных**: Данные о сделках для MT4 и MT5 загружены из базы данных с использованием SQLAlchemy и Pandas. Были применены фильтры на уровне SQL-запросов для исключения ненужных данных.
   
2. **Рассчет метрик**: Используя Pandas, были рассчитаны короткие сделки и парные сделки для каждого пользователя. Метрики вычислялись для двух разных торговых систем (MT4 и MT5).

3. **Анализ пар пользователей**: Были определены пары пользователей, которые удовлетворяют заданным условиям по промежуткам времени и направлению сделок.

## Отчет по результатам выполнения задачи

#### 1. Подключение к базе данных
- **Задача:** Подключиться к базе данных и убедиться в успешности подключения.
- **Результат:** Подключение к базе данных прошло успешно. Движок и сессия базы данных были созданы, и проверка состояния базы данных была выполнена без ошибок.

#### 2. Загрузка данных MT4
- **Задача:** Загрузить данные о сделках из таблицы MT4 с учетом фильтрации по времени открытия и закрытия сделок.
- **Результат:** Данные MT4 были успешно загружены. Датасет содержит достаточное количество записей для дальнейшего анализа.

#### 3. Рассчет метрик для MT4
- **Задача:** Определить количество коротких сделок (менее 1 минуты) и количество пар противоположных сделок, выполненных одним пользователем с разницей открытия не более 30 секунд.
- **Результат:** 
  - Было найдено 189 пользователей с короткими сделками.
  - Количество найденных пар противоположных сделок составило 192.
  - Также были найдены пары пользователей, удовлетворяющие заданным условиям. Общее количество таких пар составило 26,658.

#### 4. Загрузка данных MT5
- **Задача:** Загрузить данные о сделках из таблицы MT5 с учетом фильтрации по времени событий и исключению помеченных сделок.
- **Результат:** Данные MT5 были успешно загружены и подготовлены для анализа.

#### 5. Рассчет метрик для MT5
- **Задача:** Определить количество коротких сделок и количество пар противоположных сделок для пользователей MT5.
- **Результат:** 
  - Общее количество пар пользователей, удовлетворяющих условиям, составило 25,334.

#### 6. Сохранение результатов
- **Задача:** Сохранить рассчитанные метрики и результаты анализа в CSV файлы.
- **Результат:** 
  - Результаты анализа MT4 были сохранены в файл `short_trades_and_trade_pairs_mt4.csv`.
  - Результаты анализа пар пользователей для MT5 были сохранены в файл `user_pairs_mt5.csv`.

## Как запустить

### Локально

1. Установите зависимости:

    ```bash
    pip install -r requirements.txt
    ```

2. Создайте файл `.env` в корневой директории:

    ```plaintext
    DB_HOST=your_database_host
    DB_PORT=5432
    DB_NAME=postgres
    DB_USER=your_username
    DB_PASSWORD=your_password
    ```

3. Запустите скрипт:

    ```bash
    python main.py
    ```

### В Docker

1. Соберите Docker образ:

    ```bash
    docker build -t trade-analysis .
    ```

2. Запустите контейнер:

    ```bash
    docker run --env-file .env trade-analysis
    ```